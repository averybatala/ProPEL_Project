function nba_stats_display() {
    ob_start(); ?>
    
    <div class="nba-container">
        <!-- Month Selection -->
        <div class="month-selection">
            <h3>Select Months to Display:</h3>
            <div class="month-checkboxes">
                <label><input type="checkbox" name="months" value="10-2024" checked> October 2024</label>
                <label><input type="checkbox" name="months" value="11-2024" checked> November 2024</label>
                <label><input type="checkbox" name="months" value="12-2024" checked> December 2024</label>
            </div>
            <div class="button-group">
                <button id="loadMonthsBtn" class="nba-button">Load Selected Months</button>
                <button id="highVisitorBtn" class="nba-button">
                    Show Highest Visitor Team
                </button>
                <button id="monthlyHighVisitorBtn" class="nba-button">
                    Show Monthly Highest Visitors
                </button>
                <button id="highHomeBtn" class="nba-button">
                    Show Highest Home Team
                </button>
                <button id="monthlyHighHomeBtn" class="nba-button">
                    Show Monthly Highest Home
                </button>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="loading-indicator" style="display: none;">
            <div class="loading-spinner"></div>
            <span>Loading data...</span>
        </div>
        
        <!-- Answer Box -->
        <div id="answerBox" class="answer-box" style="display:none; margin-bottom: 20px;">
            ANSWER: <span id="answerTeam"></span> 
            (<span id="answerPoints"></span> points)
        </div>
        
        <!-- Monthly Results Container -->
        <div id="monthlyResults" style="display:none; margin-bottom: 20px;">
            <h3 id="monthlyResultsTitle">Monthly Highest Teams:</h3>
            <div id="monthlyAnswers"></div>
        </div>
        
        <!-- Table Container -->
        <div id="csvResults"></div>
    </div>

    <style>
    /* Loading Indicator Styles */
    .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 15px;
        margin: 15px 0;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #0C2340;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Button group */
    .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .nba-container {
        max-width: 100%;
        overflow-x: auto;
        margin: 20px 0;
    }
    
    .month-selection {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .month-checkboxes {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 10px 0;
    }
    
    .month-checkboxes label {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .nba-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    
    .nba-table th, .nba-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: left;
    }
    
    .nba-table th {
        background-color: #0C2340;
        color: white;
    }
    
    .nba-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .nba-button {
        padding: 10px 20px;
        background: #78BE20;
        color: #000;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .nba-button:hover {
        background: #5e9c16;
    }
    
    .answer-box {
        padding: 15px;
        background: #0C2340;
        color: white;
        font-weight: bold;
        border-radius: 4px;
        display: inline-block;
    }
    
    .monthly-answer {
        padding: 10px;
        margin: 5px 0;
        background: #0C2340;
        color: white;
        border-radius: 4px;
    }
    </style>

    <script>
    let allData = [];
    let currentFilter = null;

    document.addEventListener('DOMContentLoaded', function() {
        const initialMonths = getSelectedMonths();
        console.log("Initial selected months:", initialMonths);
        loadMonthData(initialMonths);
        
        document.getElementById('loadMonthsBtn').addEventListener('click', function() {
            const selectedMonths = getSelectedMonths();
            console.log("Selected months on button click:", selectedMonths);
            
            if (selectedMonths.length > 0) {
                loadMonthData(selectedMonths);
            } else {
                alert('Please select at least one month');
            }
        });
        
        document.getElementById('highVisitorBtn').addEventListener('click', function() {
            const selectedMonths = getSelectedMonths();
            if (selectedMonths.length === 0) {
                alert('Please select at least one month');
                return;
            }
            
            showLoading(true);
            document.getElementById('answerBox').style.display = 'none';
            document.getElementById('monthlyResults').style.display = 'none';
            
            const monthsParam = selectedMonths.join(',');
            const apiPath = `/dev?question=q1&months=${monthsParam}`;
            console.log("API Call:", apiPath);
            
            fetch(`https://dnevampawe.execute-api.us-east-1.amazonaws.com${apiPath}`)
                .then(response => response.json())
                .then(data => {
                    const parsed = JSON.parse(data.body);
                    document.getElementById('answerTeam').textContent = parsed.answer;
                    document.getElementById('answerPoints').textContent = parsed.max_value;
                    document.getElementById('answerBox').style.display = 'block';
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('csvResults').innerHTML = 
                        '<p>Error loading data. Please try again later.</p>';
                    showLoading(false);
                });
        });
        
        document.getElementById('monthlyHighVisitorBtn').addEventListener('click', function() {
            const selectedMonths = getSelectedMonths();
            if (selectedMonths.length === 0) {
                alert('Please select at least one month');
                return;
            }
            
            showLoading(true);
            document.getElementById('answerBox').style.display = 'none';
            document.getElementById('monthlyResults').style.display = 'none';
            
            document.getElementById('monthlyAnswers').innerHTML = '';
            document.getElementById('monthlyResultsTitle').textContent = 'Monthly Highest Visitor Teams:';
            
            const promises = selectedMonths.map(month => {
                return fetch(`https://dnevampawe.execute-api.us-east-1.amazonaws.com/dev?question=q1&months=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        const parsed = JSON.parse(data.body);
                        return {
                            month: month,
                            team: parsed.answer,
                            points: parsed.max_value
                        };
                    });
            });
            
            Promise.all(promises)
                .then(results => {
                    const monthlyAnswers = document.getElementById('monthlyAnswers');
                    results.forEach(result => {
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'monthly-answer';
                        monthDiv.innerHTML = 
                            `<strong>${formatMonth(result.month)}:</strong> 
                            ${result.team} (${result.points} points)`;
                        monthlyAnswers.appendChild(monthDiv);
                    });
                    document.getElementById('monthlyResults').style.display = 'block';
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('csvResults').innerHTML = 
                        '<p>Error loading monthly data. Please try again later.</p>';
                    showLoading(false);
                });
        });
        
        document.getElementById('highHomeBtn').addEventListener('click', function() {
            const selectedMonths = getSelectedMonths();
            if (selectedMonths.length === 0) {
                alert('Please select at least one month');
                return;
            }
            
            showLoading(true);
            document.getElementById('answerBox').style.display = 'none';
            document.getElementById('monthlyResults').style.display = 'none';
            
            const monthsParam = selectedMonths.join(',');
            const apiPath = `/dev?question=q2&months=${monthsParam}`;
            console.log("API Call:", apiPath);
            
            fetch(`https://dnevampawe.execute-api.us-east-1.amazonaws.com${apiPath}`)
                .then(response => response.json())
                .then(data => {
                    const parsed = JSON.parse(data.body);
                    document.getElementById('answerTeam').textContent = parsed.answer;
                    document.getElementById('answerPoints').textContent = parsed.max_value;
                    document.getElementById('answerBox').style.display = 'block';
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('csvResults').innerHTML = 
                        '<p>Error loading data. Please try again later.</p>';
                    showLoading(false);
                });
        });
        
        document.getElementById('monthlyHighHomeBtn').addEventListener('click', function() {
            const selectedMonths = getSelectedMonths();
            if (selectedMonths.length === 0) {
                alert('Please select at least one month');
                return;
            }
            
            showLoading(true);
            document.getElementById('answerBox').style.display = 'none';
            document.getElementById('monthlyResults').style.display = 'none';
            
            document.getElementById('monthlyAnswers').innerHTML = '';
            document.getElementById('monthlyResultsTitle').textContent = 'Monthly Highest Home Teams:';
            
            const promises = selectedMonths.map(month => {
                return fetch(`https://dnevampawe.execute-api.us-east-1.amazonaws.com/dev?question=q2&months=${month}`)
                    .then(response => response.json())
                    .then(data => {
                        const parsed = JSON.parse(data.body);
                        return {
                            month: month,
                            team: parsed.answer,
                            points: parsed.max_value
                        };
                    });
            });
            
            Promise.all(promises)
                .then(results => {
                    const monthlyAnswers = document.getElementById('monthlyAnswers');
                    results.forEach(result => {
                        const monthDiv = document.createElement('div');
                        monthDiv.className = 'monthly-answer';
                        monthDiv.innerHTML = 
                            `<strong>${formatMonth(result.month)}:</strong> 
                            ${result.team} (${result.points} points)`;
                        monthlyAnswers.appendChild(monthDiv);
                    });
                    document.getElementById('monthlyResults').style.display = 'block';
                    showLoading(false);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('csvResults').innerHTML = 
                        '<p>Error loading monthly data. Please try again later.</p>';
                    showLoading(false);
                });
        });
    });

    function formatMonth(monthStr) {
        const [month, year] = monthStr.split('-');
        const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
        return `${monthNames[parseInt(month) - 1]} ${year}`;
    }

    function showLoading(show) {
        document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
    }

    function getSelectedMonths() {
        return Array.from(document.querySelectorAll('input[name="months"]:checked'))
            .map(checkbox => checkbox.value);
    }

    function loadMonthData(months) {
        if (months.length === 0) {
            alert('Please select at least one month');
            return;
        }
        
        showLoading(true);
        document.getElementById('csvResults').innerHTML = '';
        document.getElementById('answerBox').style.display = 'none';
        document.getElementById('monthlyResults').style.display = 'none';
        
        const monthsParam = months.join(',');
        const apiPath = `/dev?question=full&months=${monthsParam}`;
        console.log("API Call:", apiPath);
        
        fetch(`https://dnevampawe.execute-api.us-east-1.amazonaws.com${apiPath}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.text();
            })
            .then(text => {
                try {
                    const data = JSON.parse(text);
                    allData = data.body || text;
                } catch (e) {
                    allData = text;
                }
                renderCsvTable(allData);
                showLoading(false);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('csvResults').innerHTML = 
                    '<p>Error loading data. Please try again later.</p>';
                showLoading(false);
            });
    }

    function renderCsvTable(csvText) {
        const rows = csvText.split('\n').filter(row => row.trim() !== '');
        if (rows.length < 2) {
            document.getElementById('csvResults').innerHTML = 
                '<p>No data available for selected months</p>';
            return;
        }
        
        let html = '<table class="nba-table"><thead>';
        html += '<tr>' + rows[0].split(',').map(col => '<th>' + col + '</th>').join('') + '</tr></thead><tbody>';
        
        for (let i = 1; i < rows.length; i++) {
            html += '<tr>' + rows[i].split(',').map(col => '<td>' + col + '</td>').join('') + '</tr>';
        }
        
        html += '</tbody></table>';
        document.getElementById('csvResults').innerHTML = html;
    }
    </script>
    
    <?php
    return ob_get_clean();
}
add_shortcode('nba_stats_display', 'nba_stats_display');
